let courses=[]; function formatDate(str){return new Date(str).toLocaleDateString('es-MX');} function generateGroups(course){let start=new Date(course.fecha_inicio);const now=new Date();let id=1;course.grupos=[];while(course.grupos.length<4){let end=new Date(start);end.setMonth(end.getMonth()+1);if(end>now){if(!course.grupos.some(g=>new Date(g.inicio)<end&&new Date(g.fin)>start)){course.grupos.push({id_grupo:course.id+'-'+id,inicio:start.toISOString().slice(0,10),fin:end.toISOString().slice(0,10),dias_horarios:course.dias_horarios,estado:'planificado'});id++;}}start.setDate(start.getDate()+14);}} function renderCourse(course){const g=course.grupos[0];const start=formatDate(g.inicio);const end=formatDate(g.fin);const diff=Math.floor((new Date(g.inicio)-new Date())/86400000);const discount=diff>=7;let priceHTML=discount?`<p>Precio: $${course.precio} MXN <strong>$${course.precio_descuento} MXN</strong> <span class="off">20% off por inscripciÃ³n anticipada</span></p>`:`<p>Precio: $${course.precio} MXN</p>`;let days=course.dias_horarios.map(d=>`<span class="chip">${d.dia} ${d.hora_inicio}-${d.hora_fin}</span>`).join('');let topics=course.temario.map(t=>`<li>${t}</li>`).join('');document.getElementById('courses').insertAdjacentHTML('beforeend',`<article class="course-card"><h3>${course.nombre}</h3><p>${start} - ${end}</p>${priceHTML}<div class="chips">${days}</div><button class="accordion" aria-expanded="false" aria-controls="tem-${course.id}">Ver temario</button><div id="tem-${course.id}" class="panel" hidden><ol>${topics}</ol></div><div class="actions"><button class="call-btn" data-course="${course.id}" aria-label="Agendar llamada">ðŸ“…</button><button class="enroll-btn" data-course="${course.id}">Inscribirme</button></div></article>`);} function openModal(id){document.getElementById('overlay').hidden=false;const m=document.getElementById(id);m.hidden=false;m.querySelector('input,select,textarea').focus();} function closeModal(){document.getElementById('overlay').hidden=true;document.querySelectorAll('.modal').forEach(m=>m.hidden=true);} function showToast(msg){const t=document.getElementById('toast');t.textContent=msg;t.hidden=false;setTimeout(()=>t.hidden=true,4000);} function submitEnroll(e){e.preventDefault();const fd=new FormData(e.target);fd.append('token',Date.now());fetch('api/save_enrollment.php',{method:'POST',body:fd}).then(r=>r.json()).then(d=>{showToast(d.ok?'InscripciÃ³n registrada':'Error');if(d.ok)closeModal();});} function submitCallback(e){e.preventDefault();const fd=new FormData(e.target);fd.append('token',Date.now());fetch('api/save_callback.php',{method:'POST',body:fd}).then(r=>r.json()).then(d=>{showToast(d.ok?'Agenda enviada':'Error');if(d.ok)closeModal();});} document.addEventListener('click',e=>{if(e.target.classList.contains('accordion')){const p=document.getElementById(e.target.getAttribute('aria-controls'));const ex=e.target.getAttribute('aria-expanded')==='true';e.target.setAttribute('aria-expanded',!ex);p.hidden=ex;}if(e.target.classList.contains('call-btn')){document.getElementById('callbackForm').reset();document.getElementById('callbackForm').course_id.value=e.target.dataset.course;openModal('callModal');}if(e.target.classList.contains('enroll-btn')){const c=courses.find(x=>x.id===e.target.dataset.course);const s=document.querySelector('#enrollForm select');s.innerHTML=c.grupos.map(g=>`<option value="${g.id_grupo}">${formatDate(g.inicio)}</option>`).join('');document.getElementById('enrollForm').course_id.value=c.id;openModal('enrollModal');}if(e.target.classList.contains('close-modal')||e.target.id==='overlay'){closeModal();}}); async function init(){const res=await fetch('data/courses.json');courses=await res.json();courses.forEach(c=>{generateGroups(c);renderCourse(c);});document.getElementById('enrollForm').addEventListener('submit',submitEnroll);document.getElementById('callbackForm').addEventListener('submit',submitCallback);} document.addEventListener('DOMContentLoaded',init); 